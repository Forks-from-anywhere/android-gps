<!DOCTYPE HTML>
<html>
	<head>
		<title>Red GPS</title>
		<link href="css/main.css" type="text/css" rel="stylesheet">
		<script type="text/javascript" charset="utf-8" src="cordova-2.7.0.js"></script>
		<script type="text/javascript" charset="utf-8" src="backgroundService-2.5.0.js"></script>
		<script type="text/javascript" charset="utf-8" src="locationService.js"></script>
		<script type="text/javascript" charset="utf-8">
	    document.addEventListener("deviceready", onDeviceReady, false);
	    var locationService = cordova.require('cordova/plugin/locationService');
	    var timeSet = 0;
	    var reporting = null;
	    var db = null;
	    var onSuccessLocation = function(position) {
    		alert('Latitude: '          + position.coords.latitude          + '\n' +
          	'Longitude: '         + position.coords.longitude         + '\n' +
          	'Altitude: '          + position.coords.altitude          + '\n' +
          	'Accuracy: '          + position.coords.accuracy          + '\n' +
          	'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
          	'Heading: '           + position.coords.heading           + '\n' +
          	'Speed: '             + position.coords.speed             + '\n' +
          	'Timestamp: '         + position.timestamp                + '\n');
		};
		
	    function onDeviceReady() {
	        db = window.openDatabase("redgps_conf", "1.0", "BD de Configuracion RedGPS", 1000000);
	        db.transaction(createDatabase, errorCB, successCB);	
	        db.transaction(getTimeSetFromDb, errorCB, successCB);
	        getStatus();
	    }
	    
	    function createDatabase(tx) {
	    	tx.executeSql('CREATE TABLE IF NOT EXISTS CONFIG (key unique, value)');
	    }
	    
	    function errorCB(err) {
        	alert("Error processing SQL: "+err.code);
	    }
	   	
	   	function successCB() {
        	
    	}
    	
    	function getTimeSetFromDb(tx) {
        	tx.executeSql('SELECT * FROM CONFIG WHERE key = "TIME_SET"', [], queryTimeSetSuccess, errorCB);
    	}
    	
    	function queryTimeSetSuccess(tx, results) {
    		var len = results.rows.length;
	        console.log("CONFIG table: " + len + " rows found.");
	        if (len > 0) {
	        	alert("Recuperando TimeSet");
		        timeSet = parseInt(results.rows.item(0).value);
	        } else {
	        	alert("Guardando TimeSet");
	        	tx.executeSql('INSERT INTO CONFIG(key, value) VALUES("TIME_SET", "5")');
	        	timeSet = 5;
	        }
	        //setReporting();
    	}
    	
    	function setReporting() {
    		if (reporting) {
    			clearInterval(reporting);
    		}
    		var seconds = timeSet * 60000;
    		alert("Seconds: " + seconds);
    		reporting = setInterval(function(){
    			navigator.geolocation.getCurrentPosition(onSuccessLocation, onErrorLocation);
    		}, seconds);
    	}
    	
    	function onErrorLocation(error) {
		    alert('code: '    + error.code    + '\n' +
		          'message: ' + error.message + '\n');
		}
    	
    	function startService() {
    			locationService.startService(	function(r){handleSuccess(r)},
					function(e){handleError(e)});
    	}
    	
    	function handleSuccess(data) {
			updateView(data);
		}
    	
    	function handleError(data) {
			alert("Error: " + data.ErrorMessage);
			alert(JSON.stringify(data));
			updateView(data);
		}
		/*
		* Button Handlers
		*/
		function getStatus() {
			locationService.getStatus(function(r){ handleSuccess(r); },
				function(e){handleError(e);});
		};
		 
		function startService() {
			locationService.startService(	function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		function stopService() {
			locationService.stopService(function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		function enableTimer() {
			alert("Setting timer");
			var newTimeSet = 0;
			try {
				newTimeSet = parseInt(document.getElementById('txtTimer').value);
			} catch(err) {
				alert("The time set value is not valid");
			}
			if (newTimeSet != timeSet) {
				timeSet = newTimeSet;
				db.executeSql('UPDATE CONFIG SET value = "' + timeSet + '" WHERE key = "TIME_SET"');
			}
			locationService.enableTimer(timeSet * 60000,
				function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		
		function disableTimer() {
			locationService.disableTimer(function(r){handleSuccess(r)},
				function(e){handleError(e)});
		};
		
		function registerForBootStart() {
			locationService.registerForBootStart(function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		function deregisterForBootStart() {
			locationService.deregisterForBootStart(function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		function setConfig() {
			var helloToTxt = document.getElementById("helloToTxt");
			var helloToString = helloToTxt.value;
		  	var config = {
		  		"HelloTo" : helloToString
		  	};
			locationService.setConfiguration(config,
				function(r){handleSuccess(r)},
				function(e){handleError(e)});
		}
		
		/*
		* View logic
		*/
		function updateView(data) {
			var serviceBtn = document.getElementById("toggleService");
			var timerBtn = document.getElementById("toggleTimer");
			var txtTimer = document.getElementById("txtTimer");
			var bootBtn = document.getElementById("toggleBoot");
			var updateBtn = document.getElementById("updateBtn");
			var refreshBtn = document.getElementById("refreshBtn");
			
			txtTimer.value = timeSet;
			serviceBtn.disabled = false;
			if (data.ServiceRunning) {
				serviceBtn.value = "Running";
				serviceBtn.onclick = stopService;
				timerBtn.disabled = false;
				if (data.TimerEnabled) {
					timerBtn.onclick = disableTimer;
					timerBtn.value = "Enabled";
				} else {
					timerBtn.onclick = enableTimer;
					timerBtn.value = "Disabled";
				}
				updateBtn.disabled = false;
				updateBtn.onclick = setConfig;
		
				refreshBtn.disabled = false;
				refreshBtn.onclick = getStatus;
			} else {
				serviceBtn.onclick = startService;
				serviceBtn.value = "Not running";
				timerBtn.disabled = true;
				timerEnabled = false;
				
				updateBtn.disabled = true;
				refreshBtn.disabled = true;
			}
			bootBtn.disabled = false;
			if (data.RegisteredForBootStart) {
				bootBtn.onclick = deregisterForBootStart;
				bootBtn.value = "Registered";
			} else {
				bootBtn.onclick = registerForBootStart;
				bootBtn.value = "Not registered";
			}
			
			if (data.LatestResult != null)
			{
				try {
					var resultMessage = document.getElementById("resultMessage");
					resultMessage.innerHTML = data.LatestResult.Message;
				} catch (err) {}
			}
		}
	    </script> 
	</head>
	<body>
	<header>
		<img src="images/Logo_redgps.png" alt="Logo" />
	</head>
	<content>
		<table>
			<tr>
			<th>Service</th>
			<td><div id="serviceStatus"></div></td>
			<td><input id="toggleService" type="button" value="toggle"/></td>
			</tr>
			<tr>
			<th>Timer</th>
			<td><input type="number" id="txtTimer" />(min)
			<div id="timerStatus"></div></td>
			<td><input id="toggleTimer" type="button" value="toggle"/></td>
			</tr>
			<tr>
			<th>Boot</th>
			<td><div id="bootStatus"></div></td>
			<td><input id="toggleBoot" type="button" value="toggle"/></td>
			</tr>
			
			<tr>
			<th colspan=3 align="center">Configuration</th>
			</tr>
			
			<tr>
			<td colspan=3 align="center"><input disabled id="updateBtn" type="button" value="Update Config"/></td>
			</tr>
			
			<tr>
			<th colspan=3 align="center">Latest Result</th>
			</tr>
			
			<tr>
			<td colspan=3 align="center"><div id="resultMessage"></div></td>
			</tr>
			
			<tr>
			<td colspan=3 align="center"><input disabled id="refreshBtn" type="button" value="Refresh"/></td>
			</tr>
		</table>
	</content>
	</body>
</html>